<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamebook Cassette Editor</title>
    <style>
        body { background: #222; color: #eee; font-family: sans-serif; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        
        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆ */
        #sidebar { width: 250px; background: #1a1a1a; border-right: 1px solid #444; display: flex; flex-direction: column; }
        #scene-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .scene-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.9em; }
        .scene-item:hover { background: #333; }
        .scene-item.active { background: #4caf50; color: #fff; }
        #sidebar-footer { padding: 10px; border-top: 1px solid #444; }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ï¼šç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
        #main-editor { flex-grow: 1; padding: 20px; overflow-y: auto; background: #222; }
        .form-group { margin-bottom: 15px; border: 1px solid #444; padding: 15px; border-radius: 5px; background: #2a2a2a; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.8em; }
        input[type="text"], input[type="number"], textarea, select { 
            width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: #fff; box-sizing: border-box; 
        }
        textarea { height: 80px; resize: vertical; }
        
        /* ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        #image-preview { max-width: 200px; max-height: 150px; display: block; margin-top: 5px; border: 1px solid #555; }

        /* é¸æŠè‚¢ã‚¨ãƒªã‚¢ */
        .option-item { background: #333; padding: 10px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #4caf50; }
        .btn { padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px; font-size: 0.9em; }
        .btn-primary { background: #4caf50; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-secondary { background: #555; color: white; }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        h2, h3 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <div style="padding:10px; font-weight:bold; background:#111;">ã‚·ãƒ¼ãƒ³ä¸€è¦§</div>
    <div id="scene-list">
        </div>
    <div id="sidebar-footer">
        <button class="btn btn-primary" onclick="addNewScene()" style="width:100%">ï¼‹ æ–°è¦ã‚·ãƒ¼ãƒ³è¿½åŠ </button>
    </div>
</div>

<div id="main-editor">
    <div class="form-group">
        <h3>ã‚«ã‚»ãƒƒãƒˆè¨­å®š (Global)</h3>
        <div class="row">
            <div class="col">
                <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="meta-title" onchange="updateMeta()">
            </div>
            <div class="col">
                <label>ã‚¸ãƒ£ãƒ³ãƒ«</label>
                <input type="text" id="meta-genre" onchange="updateMeta()">
            </div>
        </div>
        <label>AIã¸ã®æŒ‡ç¤º (GM Instruction)</label>
        <textarea id="meta-instruction" onchange="updateMeta()"></textarea>
        <div style="margin-top:10px;">
            <button class="btn btn-secondary" onclick="exportJSON()">ğŸ’¾ JSONã‚’ä¿å­˜ (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰)</button>
            <input type="file" id="import-file" style="display:none" onchange="importJSON(this)">
            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">ğŸ“‚ JSONã‚’èª­è¾¼</button>
        </div>
    </div>

    <div id="scene-editor-area" style="display:none;">
        <div class="form-group">
            <div class="row">
                <div class="col" style="flex:0 0 80px;">
                    <label>ID</label>
                    <input type="number" id="scene-id" readonly style="background:#444;">
                </div>
                <div class="col">
                    <label>ã‚·ãƒ¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="scene-title" oninput="saveCurrentScene()">
                </div>
            </div>
            
            <label>æœ¬æ–‡ (Text)</label>
            <textarea id="scene-text" style="height:120px;" oninput="saveCurrentScene()"></textarea>

            <label>ç”»åƒ (URL ã¾ãŸã¯ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦åŸ‹ã‚è¾¼ã¿)</label>
            <input type="text" id="scene-image-url" placeholder="http://... ã¾ãŸã¯ ä¸‹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰" oninput="previewImage(this.value); saveCurrentScene()">
            <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(this)" style="margin-top:5px;">
            <img id="image-preview" src="">

            <label>ã‚¢ã‚¤ãƒ†ãƒ å…¥æ‰‹ (Get Item)</label>
            <input type="text" id="scene-get-item" placeholder="å…¥æ‰‹ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ å (ç©ºæ¬„ã§ãªã—)" oninput="saveCurrentScene()">
        </div>

        <div class="form-group">
            <label>é¸æŠè‚¢ (Next Options)</label>
            <div id="options-container">
                </div>
            <button class="btn btn-secondary" onclick="addOption()">ï¼‹ é¸æŠè‚¢ã‚’è¿½åŠ </button>
        </div>
        
        <button class="btn btn-danger" onclick="deleteScene()">ã“ã®ã‚·ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
    </div>
</div>

<script>
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    let scenarioData = {
        cartridge_info: { title: "æ–°ã—ã„å†’é™º", genre: "Fantasy" },
        global_settings: { ai_instruction: "ã‚ãªãŸã¯GMã§ã™ã€‚" },
        events: []
    };
    
    let currentSceneIndex = -1;

    // åˆæœŸåŒ–
    window.onload = () => {
        addNewScene(); // æœ€åˆã®ã‚·ãƒ¼ãƒ³ã‚’ä½œã‚‹
        renderSceneList();
        loadMeta();
    };

    // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿/ä¿å­˜
    function loadMeta() {
        document.getElementById('meta-title').value = scenarioData.cartridge_info.title || "";
        document.getElementById('meta-genre').value = scenarioData.cartridge_info.genre || "";
        document.getElementById('meta-instruction').value = scenarioData.global_settings.ai_instruction || "";
    }
    function updateMeta() {
        scenarioData.cartridge_info.title = document.getElementById('meta-title').value;
        scenarioData.cartridge_info.genre = document.getElementById('meta-genre').value;
        scenarioData.global_settings.ai_instruction = document.getElementById('meta-instruction').value;
    }

    // ã‚·ãƒ¼ãƒ³ãƒªã‚¹ãƒˆæç”»
    function renderSceneList() {
        const list = document.getElementById('scene-list');
        list.innerHTML = "";
        
        scenarioData.events.sort((a, b) => a.id - b.id).forEach((scene, index) => {
            const div = document.createElement('div');
            div.className = `scene-item ${index === currentSceneIndex ? 'active' : ''}`;
            div.innerText = `ID:${scene.id} ${scene.title}`;
            div.onclick = () => selectScene(index);
            list.appendChild(div);
        });
    }

    // ã‚·ãƒ¼ãƒ³é¸æŠæ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
    function selectScene(index) {
        currentSceneIndex = index;
        const scene = scenarioData.events[index];
        
        document.getElementById('scene-editor-area').style.display = 'block';
        document.getElementById('scene-id').value = scene.id;
        document.getElementById('scene-title').value = scene.title;
        document.getElementById('scene-text').value = scene.text;
        document.getElementById('scene-image-url').value = scene.image_url || "";
        document.getElementById('scene-get-item').value = scene.get_item || "";
        previewImage(scene.image_url || "");

        renderOptions(scene.next_options || []);
        renderSceneList(); // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
    }

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ & Base64å¤‰æ›å‡¦ç†
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // Base64æ–‡å­—åˆ—ã‚’å–å¾—
                const base64String = e.target.result;
                // URLå…¥åŠ›æ¬„ã«å…¥ã‚Œã‚‹
                document.getElementById('scene-image-url').value = base64String;
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                previewImage(base64String);
                // ä¿å­˜
                saveCurrentScene();
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function previewImage(url) {
        const img = document.getElementById('image-preview');
        img.src = url;
        img.style.display = url ? 'block' : 'none';
    }

    // é¸æŠè‚¢ã®æç”»
    function renderOptions(options) {
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        options.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'option-item';
            div.innerHTML = `
                <div class="row">
                    <div class="col"><label>ãƒ©ãƒ™ãƒ«</label><input type="text" value="${opt.label}" oninput="updateOption(${idx}, 'label', this.value)"></div>
                    <div class="col" style="flex:0 0 80px;"><label>è¡Œå…ˆID</label><input type="number" value="${opt.target_id}" oninput="updateOption(${idx}, 'target_id', this.value)"></div>
                </div>
                <div style="margin-top:5px;">
                    <label>å¿…è¦ã‚¢ã‚¤ãƒ†ãƒ </label>
                    <input type="text" value="${opt.req_item || ''}" placeholder="ç©ºæ¬„ã§åˆ¶é™ãªã—" oninput="updateOption(${idx}, 'req_item', this.value)">
                </div>
                <button class="btn btn-danger" style="margin-top:5px; font-size:0.8em;" onclick="removeOption(${idx})">å‰Šé™¤</button>
            `;
            container.appendChild(div);
        });
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ï¼ˆå…¥åŠ›ãŒã‚ã‚‹ãŸã³ã«æ›´æ–°ï¼‰
    window.saveCurrentScene = function() {
        if (currentSceneIndex === -1) return;
        const scene = scenarioData.events[currentSceneIndex];
        
        scene.title = document.getElementById('scene-title').value;
        scene.text = document.getElementById('scene-text').value;
        scene.image_url = document.getElementById('scene-image-url').value;
        scene.get_item = document.getElementById('scene-get-item').value;
        
        // ãƒªã‚¹ãƒˆã®ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°ã®ãŸã‚å†æç”»
        const listItems = document.querySelectorAll('.scene-item');
        if(listItems[currentSceneIndex]) {
            listItems[currentSceneIndex].innerText = `ID:${scene.id} ${scene.title}`;
        }
    };

    // é¸æŠè‚¢æ“ä½œ
    window.addOption = function() {
        if (currentSceneIndex === -1) return;
        if (!scenarioData.events[currentSceneIndex].next_options) {
            scenarioData.events[currentSceneIndex].next_options = [];
        }
        scenarioData.events[currentSceneIndex].next_options.push({ label: "é¸æŠè‚¢", target_id: 1 });
        renderOptions(scenarioData.events[currentSceneIndex].next_options);
    };

    window.updateOption = function(optIdx, key, val) {
        if (key === 'target_id') val = parseInt(val);
        scenarioData.events[currentSceneIndex].next_options[optIdx][key] = val;
    };

    window.removeOption = function(optIdx) {
        scenarioData.events[currentSceneIndex].next_options.splice(optIdx, 1);
        renderOptions(scenarioData.events[currentSceneIndex].next_options);
    };

    // ã‚·ãƒ¼ãƒ³æ“ä½œ
    window.addNewScene = function() {
        // æ–°ã—ã„IDã‚’è‡ªå‹•ç”Ÿæˆï¼ˆæœ€å¤§ID + 1ï¼‰
        const maxId = scenarioData.events.reduce((max, s) => Math.max(max, s.id), 0);
        const newScene = {
            id: maxId + 1,
            title: "æ–°è¦ã‚·ãƒ¼ãƒ³",
            text: "ã“ã“ã«æœ¬æ–‡ã‚’å…¥åŠ›...",
            next_options: []
        };
        scenarioData.events.push(newScene);
        renderSceneList();
        selectScene(scenarioData.events.length - 1);
    };

    window.deleteScene = function() {
        if(!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        scenarioData.events.splice(currentSceneIndex, 1);
        renderSceneList();
        document.getElementById('scene-editor-area').style.display = 'none';
        currentSceneIndex = -1;
    };

    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ›
    window.exportJSON = function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scenarioData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", (scenarioData.cartridge_info.title || "scenario") + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    };

    window.importJSON = function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                scenarioData = JSON.parse(e.target.result);
                loadMeta();
                renderSceneList();
                document.getElementById('scene-editor-area').style.display = 'none';
                alert("èª­ã¿è¾¼ã¿å®Œäº†ï¼");
            } catch(err) {
                alert("ã‚¨ãƒ©ãƒ¼: JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
            }
        };
        reader.readAsText(file);
    };

</script>
</body>
</html>