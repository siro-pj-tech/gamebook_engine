<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI GameBook Engine v1.1</title>
    <style>
        /* =========================================
           åŸºæœ¬è¨­å®š & èƒŒæ™¯
           ========================================= */
        body { 
            margin: 0; padding: 0; 
            background: url('bg_gamebooks.png') no-repeat center center fixed; 
            background-size: cover; 
            font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
            color: #2c1a12; 
            /* â–¼â–¼â–¼ ã‚¹ãƒãƒ›ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å¯¾ç­– (dvh) â–¼â–¼â–¼ */
            height: 100vh;
            height: 100dvh; 
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        #main-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            position: relative;
            box-sizing: border-box;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        #header-bar {
            height: 50px; 
            display: flex;
            align-items: center;
            padding: 0 15px;
            background: rgba(0,0,0,0.7); 
            color: #f0e68c;
            text-shadow: 2px 2px 4px #000;
            font-size: 1.2em;
            font-weight: bold;
            z-index: 10;
            border-bottom: 1px solid #5d4037;
            flex-shrink: 0; 
        }

        /* æœ¬ã®æœ¬ä½“ (ãƒã‚¹ã‚¯ã‚¨ãƒªã‚¢) */
        #book-wrapper {
            flex: 1; 
            /* â–¼â–¼â–¼ ã“ã‚ŒãŒé‡è¦ï¼šãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹å†…ã§ç¸®å°ã‚’è¨±å¯ã™ã‚‹ â–¼â–¼â–¼ */
            min-height: 0; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: hidden;
            position: relative;
        }

        #book-spread {
            display: flex;
            width: 95%;
            max-width: 1200px;
            height: 95%; 
            background-color: rgba(250, 245, 235, 0.95);
            box-shadow: 
                0 0 20px rgba(0,0,0,0.5), 
                inset 0 0 50px rgba(139, 69, 19, 0.1); 
            border-radius: 4px;
            border: 1px solid #8d6e63;
            position: relative;
        }
        
        #book-spine {
            width: 2px;
            background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.2), transparent);
            height: 100%;
            flex-shrink: 0;
        }

        .page {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto; 
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: #8d6e63 transparent;
        }

        /* å·¦ãƒšãƒ¼ã‚¸è¦ç´  */
        #scene-visual {
            width: 100%;
            height: 35%; 
            min-height: 150px;
            background-color: #d7ccc8;
            border: 2px solid #5d4037;
            object-fit: cover;
            border-radius: 2px;
            filter: sepia(0.3);
            flex-shrink: 0;
        }

        #scene-text-area {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 1.1em;
            line-height: 1.7;
            border-bottom: 1px dashed #8d6e63;
            padding-bottom: 10px;
            min-height: 80px; 
        }

        #inventory-area {
            flex-shrink: 0;
            min-height: 30px;
            font-size: 0.9em;
            color: #5d4037;
            background: rgba(0,0,0,0.05);
            padding: 5px;
            border-radius: 4px;
        }
        .inventory-tag {
            display: inline-block;
            background: #fff;
            border: 1px solid #8d6e63;
            padding: 2px 6px;
            margin: 2px;
            border-radius: 8px;
            font-size: 0.8em;
        }

        /* å³ãƒšãƒ¼ã‚¸è¦ç´  */
        #chat-log-area {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 1em;
            line-height: 1.6;
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border-radius: 4px;
            min-height: 100px;
        }
        .log-entry { margin-bottom: 10px; border-bottom: 1px solid rgba(93, 64, 55, 0.2); padding-bottom: 8px; }
        .log-ai { color: #2c1a12; }
        .log-user { color: #1565c0; font-style: italic; font-weight: bold; }
        .log-system { color: #757575; font-size: 0.8em; }
        .log-usage { font-size: 0.7em; color: #aaa; text-align: right; margin-top: -4px; }

        #choices-area {
            flex-shrink: 0; 
            min-height: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-top: 10px;
            border-top: 1px solid #8d6e63;
        }
        
        .book-btn {
            background: #fff;
            border: 1px solid #5d4037;
            padding: 12px;
            text-align: left;
            cursor: pointer;
            font-family: "Yu Mincho", serif;
            font-weight: bold;
            color: #3e2723;
            box-shadow: 2px 2px 0px rgba(93, 64, 55, 0.2);
            font-size: 0.95em;
        }
        .book-btn:active { background: #efebe9; transform: translateY(1px); }
        .book-btn.disabled { opacity: 0.6; background: #d7ccc8; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        #footer-bar {
            background: rgba(30, 20, 10, 0.95);
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 10px;
            font-size: 0.8em;
            border-top: 1px solid #5d4037;
            flex-shrink: 0; /* ç¸®å°ç¦æ­¢ */
            min-height: 50px; /* æœ€ä½ä¿è¨¼ */
            box-sizing: border-box;
            /* æŠ˜ã‚Šè¿”ã—è¨±å¯ */
            flex-wrap: wrap; 
        }

        #stats-monitor {
            font-family: "Consolas", monospace;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .stat-item { color: #81c784; }
        .limit-warn { color: #ffeb3b; }
        .limit-danger { color: #ff5252; font-weight: bold; }

        .footer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .system-btn {
            background: #4e342e;
            color: #fff;
            border: 1px solid #6d4c41;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.9em;
            white-space: nowrap;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #config-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; justify-content: center; align-items: center;
            overflow-y: auto; 
        }
        .modal-box {
            background: #fffaf0; color: #3e2723;
            padding: 20px; border-radius: 4px; border: 4px double #5d4037;
            width: 90%; max-width: 450px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            position: relative;
        }
        .api-input-group { display: flex; align-items: center; gap: 5px; margin: 5px 0 15px; }
        .help-btn { width: 30px; height: 30px; background: #8d6e63; color: white; border: none; border-radius: 50%; }
        .help-box { display: none; background: #efebe9; padding: 10px; margin-bottom: 15px; font-size: 0.85em; }
        input, select { padding: 10px; border: 1px solid #8d6e63; background: #fff; width: 100%; box-sizing: border-box; }

        /* =========================================
           â˜… ã‚¹ãƒãƒ›ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–è¨­å®š v1.2
           ========================================= */
        @media screen and (max-width: 768px) {
            /* ãƒ•ãƒƒã‚¿ãƒ¼ã®å®‰å…¨å¯¾ç­– */
            #footer-bar {
                flex-direction: column; /* ç¸¦ä¸¦ã³ */
                justify-content: center;
                gap: 5px;
                padding: 5px;
                height: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«åˆã‚ã›ã¦ä¼¸ã³ã‚‹ */
                padding-bottom: env(safe-area-inset-bottom); /* iPhone Xä»¥é™ã®ä¸‹éƒ¨ãƒãƒ¼å¯¾ç­– */
            }

            #stats-monitor {
                width: 100%;
                justify-content: center;
                font-size: 0.7em;
                border-bottom: 1px solid #555;
                padding-bottom: 2px;
            }

            .footer-controls {
                width: 100%;
                justify-content: center; /* ä¸­å¤®æƒãˆ */
                margin: 0;
                padding-bottom: 2px;
            }

            /* æœ¬ã®ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒ– */
            #book-wrapper {
                padding: 0;
                display: block; 
                overflow-y: auto; 
                -webkit-overflow-scrolling: touch; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ…£æ€§ */
            }

            #book-spread {
                flex-direction: column; 
                width: 100%;
                height: auto; 
                min-height: 100%;
                box-shadow: none; 
                border: none;
                background-color: transparent; 
            }

            #book-spine { display: none; } 

            .page {
                background-color: rgba(250, 245, 235, 0.98); 
                margin-bottom: 0;
                border-radius: 0;
                border-bottom: 2px solid #8d6e63;
                flex: none; 
                height: auto;
                padding: 15px;
            }

            /* å„è¦ç´ ã®é«˜ã•èª¿æ•´ */
            #scene-visual { height: 180px; margin-bottom: 10px; }
            #scene-text-area { font-size: 1em; max-height: none; min-height: auto; }
            #chat-log-area { height: 180px; } /* ãƒ­ã‚°ã¯è¦‹ã‚„ã™ã */

            /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼èª¿æ•´ */
            input[type="range"] { width: 80px; }
        }
    </style>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
</head>
<body>
    <div id="config-modal">
        <div class="modal-box">
            <h2>AI GameBook Engine v1.1</h2>
            
            <label>1. Gemini API Key</label>
            <div class="api-input-group">
                <input type="password" id="api-key" placeholder="API Keyã‚’å…¥åŠ›">
                <button class="help-btn" onclick="toggleHelp()">?</button>
            </div>
            
            <div id="help-text" class="help-box">
                <strong>ã€APIã‚­ãƒ¼ã®å–å¾—æ–¹æ³•ã€‘</strong><br>
                1. <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> ã¸<br>
                2. ã€ŒCreate API keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
                3. ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘<br>
            </div>

            <label>2. å†’é™ºã®æ›¸ã‚’é¸ã¶</label>
            <select id="preset-select" style="margin-bottom:10px;">
                <option value="">(åéŒ²ã‚¿ã‚¤ãƒˆãƒ«ã‚’é¸æŠ)</option>
                <option value="horror_village.json">ãƒ›ãƒ©ãƒ¼ï¼šè‰æ™‚é›¨ã®å¿Œã¿æ‘</option>
            </select>
            <input type="file" id="json-file" accept=".json" onchange="document.getElementById('preset-select').value=''">
            
            <button class="book-btn" onclick="startNewGame()" style="width:100%; text-align:center; background:#8d6e63; color:white; margin-top:10px;">ç‰©èªã‚’å§‹ã‚ã‚‹</button>
            <div style="text-align:center; margin:10px; color:#888;">ã¾ãŸã¯</div>
            
            <input type="file" id="save-file" accept=".json" style="display:none" onchange="loadSaveGame(this)">
            <button class="book-btn" onclick="checkAndLoadSave()" style="width:100%; text-align:center; background:#d7ccc8;">ã—ãŠã‚Šã‹ã‚‰å†é–‹</button>
            
            <div id="error-message" style="color:#d32f2f; margin-top:10px; font-size:0.9em; text-align:center; font-weight:bold;"></div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px dashed #8d6e63; text-align: center; font-size: 0.9em;">
                <a href="editor.html" target="_blank" style="color: #5d4037; font-weight: bold;">âœ’ï¸ å†’é™ºã®æ›¸ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚’é–‹ã</a>
            </div>
        </div>
    </div>

    <div id="main-container">
        <div id="header-bar">
            <span id="game-title">AI GameBook Engine</span>
        </div>

        <div id="book-wrapper">
            <div id="book-spread">
                <div class="page" id="left-page">
                    <img id="scene-visual" src="" alt="æŒ¿çµµ">
                    <div id="scene-text-area">ç‰©èªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
                    <div id="inventory-area">
                        <strong>æ‰€æŒå“:</strong> <span id="inventory-list">ãªã—</span>
                    </div>
                </div>
                
                <div id="book-spine"></div>

                <div class="page" id="right-page">
                    <div id="chat-log-area">
                        <div class="log-entry log-system">ã‚·ã‚¹ãƒ†ãƒ : æº–å‚™å®Œäº†</div>
                    </div>
                    <div id="choices-area">
                        </div>
                </div>
            </div>
        </div>

        <div id="footer-bar">
            <div id="stats-monitor">
                <span class="stat-item">RPM:<span id="stat-rpm">0/15</span></span>
                <span class="stat-item">TPM:<span id="stat-tpm">0/1M</span></span>
                <span class="stat-item">RPD:<span id="stat-rpd">0/1500</span></span>
            </div>

            <div class="footer-controls">
                <span style="font-size:0.8em;">æ–‡å­—:</span>
                <input type="range" min="12" max="24" value="16" oninput="changeFontSize(this.value)">
                <button class="system-btn" onclick="saveProgress()">ğŸ’¾ ä¿å­˜</button>
                <button id="btn-back" class="system-btn" onclick="executeBack()">â†©ï¸ æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        window.scenarioData = null;
        window.genAI = null;
        window.model = null;
        window.inventory = new Set();
        window.cassetteFileName = "";
        window.backUsed = false;
        window.lastTurnState = null;
        
        const LIMITS = { RPM: 15, TPM: 1000000, RPD: 1500 };
        let requestHistory = [];

        window.onload = () => {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) document.getElementById('api-key').value = savedKey;
            updateStats(0);
        };

        window.toggleHelp = () => {
            const el = document.getElementById('help-text');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        };

        window.changeFontSize = (size) => {
            document.getElementById('scene-text-area').style.fontSize = size + "px";
            document.getElementById('chat-log-area').style.fontSize = size + "px";
        };

        async function prepareGame() {
            const apiKey = document.getElementById('api-key').value;
            const fileInput = document.getElementById('json-file');
            const presetSelect = document.getElementById('preset-select');
            const errorMsg = document.getElementById('error-message');

            if (!apiKey) { errorMsg.innerText = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return false; }
            localStorage.setItem('gemini_api_key', apiKey);
            
            try {
                window.genAI = new GoogleGenerativeAI(apiKey);
                window.model = window.genAI.getGenerativeModel({ model: "gemini-2.5-flash" }); 
            } catch(e) {
                errorMsg.innerText = "ãƒ¢ãƒ‡ãƒ«åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + e;
                return false;
            }

            if (fileInput.files.length > 0) {
                window.cassetteFileName = fileInput.files[0].name;
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            window.scenarioData = JSON.parse(e.target.result);
                            applyTitle();
                            resolve(true);
                        } catch (err) { errorMsg.innerText = "JSONèª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err; resolve(false); }
                    };
                    reader.readAsText(fileInput.files[0]);
                });
            } else if (presetSelect.value) {
                window.cassetteFileName = presetSelect.value;
                try {
                    const response = await fetch(presetSelect.value);
                    if (!response.ok) throw new Error("File not found");
                    window.scenarioData = await response.json();
                    applyTitle();
                    return true;
                } catch (err) { errorMsg.innerText = "ãƒ—ãƒªã‚»ãƒƒãƒˆèª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err; return false; }
            } else {
                errorMsg.innerText = "ã€Œå†’é™ºã®æ›¸ã€ã‚’é¸æŠã—ã¦ãã ã•ã„";
                return false;
            }
        }

        function applyTitle() {
            const title = window.scenarioData.cartridge_info?.title || "Unknown Adventure";
            document.title = title;
            document.getElementById('game-title').innerText = title;
        }

        window.startNewGame = async () => {
            if (!await prepareGame()) return;
            window.inventory = new Set();
            window.backUsed = false;
            window.lastTurnState = null;
            updateInventoryUI();
            updateBackBtnState();
            document.getElementById('config-modal').style.display = 'none';
            loadScene(window.scenarioData.events[0].id);
        };

        window.checkAndLoadSave = () => {
            const fileInput = document.getElementById('json-file');
            const presetSelect = document.getElementById('preset-select');
            const errorMsg = document.getElementById('error-message');
            
            if (fileInput.files.length === 0 && !presetSelect.value) {
                errorMsg.innerText = "âš ï¸ å…ˆã«ã€Œå†’é™ºã®æ›¸ã€ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„";
                return;
            }
            errorMsg.innerText = "";
            document.getElementById('save-file').click();
        };

        window.loadSaveGame = async (input) => {
            const saveFile = input.files[0];
            if (!saveFile) return;
            if (!await prepareGame()) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const saveData = JSON.parse(e.target.result);
                    if (saveData.cassetteFileName !== window.cassetteFileName) {
                        alert(`é•ã†ç‰©èªã®ã—ãŠã‚Šã§ã™ã€‚\nå¿…è¦: ${saveData.cassetteFileName}\nç¾åœ¨: ${window.cassetteFileName}`);
                        return;
                    }
                    window.inventory = new Set(saveData.inventory);
                    window.backUsed = saveData.backUsed;
                    window.lastTurnState = saveData.lastTurnState;
                    updateInventoryUI();
                    updateBackBtnState();
                    document.getElementById('config-modal').style.display = 'none';
                    addLog(`ã€ã‚·ã‚¹ãƒ†ãƒ ã€‘ ã—ãŠã‚Šã‹ã‚‰å†é–‹ã—ã¾ã™ (${saveData.date})`, 'system');
                    loadScene(saveData.currentSceneId);
                } catch (err) { alert("ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + err); }
            };
            reader.readAsText(saveFile);
        };

        window.loadScene = (sceneId) => {
            const scene = window.scenarioData.events.find(e => e.id === sceneId);
            if (!scene) return;
            window.currentSceneId = sceneId;

            if (scene.get_item && !window.inventory.has(scene.get_item)) {
                window.inventory.add(scene.get_item);
                updateInventoryUI();
                addLog(`ã€å…¥æ‰‹ã€‘ ${scene.get_item}`, 'system');
            }

            const visual = document.getElementById('scene-visual');
            visual.style.opacity = 0;
            setTimeout(() => {
                visual.src = scene.image_url || "https://placehold.co/600x400/d7ccc8/5d4037?text=No+Image";
                visual.style.opacity = 1;
            }, 300);

            document.getElementById('scene-text-area').innerHTML = 
                `<strong style="font-size:1.1em; color:#8d6e63;">â—† ${scene.title}</strong><br><br>${scene.text}`;
            
            addLog(`\nâ”â” ${scene.title} â”â”`, 'system');
            renderButtons(scene);
        };

        function renderButtons(scene) {
            const area = document.getElementById('choices-area');
            area.innerHTML = ''; 
            if (scene.next_options && scene.next_options.length > 0) {
                scene.next_options.forEach(opt => {
                    const btn = document.createElement('div');
                    if (opt.req_item && !window.inventory.has(opt.req_item)) {
                        btn.className = 'book-btn disabled';
                        btn.innerHTML = `ğŸ”’ ${opt.label} <small>(å¿…è¦: ${opt.req_item})</small>`;
                    } else {
                        btn.className = 'book-btn';
                        btn.innerText = "â–¶ " + opt.label;
                        btn.onclick = () => handleChoice(opt.target_id, opt.label, scene);
                    }
                    area.appendChild(btn);
                });
            } else {
                const btn = document.createElement('div');
                btn.className = 'book-btn';
                btn.innerText = "å®Œ (ã‚¿ã‚¤ãƒˆãƒ«ã¸)";
                btn.onclick = () => location.reload();
                area.appendChild(btn);
            }
        }

        window.handleChoice = async (nextId, userAction, currentScene) => {
            const nextScene = window.scenarioData.events.find(e => e.id === nextId);
            const area = document.getElementById('choices-area');
            
            window.lastTurnState = {
                sceneId: currentScene.id,
                inventory: new Set(window.inventory)
            };
            updateBackBtnState();

            area.innerHTML = '<div style="color:#8d6e63; font-style:italic; padding:10px;">ç‰©èªã‚’ç´¡ã„ã§ã„ã¾ã™...</div>';
            addLog(`ã‚ãªãŸ: ${userAction}`, 'user');

            const gmInstruction = window.scenarioData.global_settings?.ai_instruction || "ã‚ãªãŸã¯GMã§ã™ã€‚";
            const invStr = Array.from(window.inventory).join(", ");
            const prompt = `${gmInstruction}\nã€æ‰€æŒå“ã€‘${invStr}\nã€çŠ¶æ³ã€‘${currentScene.text}\nã€è¡Œå‹•ã€‘${userAction}\nã€çµæœã€‘${nextScene.text}\nè¡Œå‹•ã‹ã‚‰çµæœã¾ã§ã®éç¨‹ã‚’150æ–‡å­—ä»¥å†…ã®å°èª¬ã§æå†™ã›ã‚ˆã€‚`;

            try {
                const result = await window.model.generateContent(prompt);
                const response = await result.response;
                const text = response.text();
                
                const tokens = response.usageMetadata ? response.usageMetadata.totalTokenCount : 0;
                updateStats(tokens);
                
                addLog(text, 'ai');
                if(tokens > 0) addLog(`(æ¶ˆè²»: ${tokens} tokens)`, 'usage');

                setTimeout(() => loadScene(nextId), 2000);
            } catch (error) {
                console.error(error);
                addLog("ã‚¨ãƒ©ãƒ¼: AIæ¥ç¶šå¤±æ•—ã€‚ç§»å‹•ã—ã¾ã™ã€‚", 'system');
                setTimeout(() => loadScene(nextId), 2000);
            }
        };

        const getDailyStats = () => {
            const s = JSON.parse(localStorage.getItem('gemini_game_stats') || '{"count":0, "date":""}');
            const today = new Date().toLocaleDateString();
            if(s.date !== today) { s.date = today; s.count = 0; }
            return s;
        };

        function updateStats(newTokens) {
            const s = getDailyStats();
            if(newTokens !== 0 || s.count === 0) {
                s.count++;
                localStorage.setItem('gemini_game_stats', JSON.stringify(s));
            }
            if(newTokens !== 0) requestHistory.push({t: Date.now(), k: newTokens});
            const now = Date.now();
            requestHistory = requestHistory.filter(r => now - r.t < 60000);

            const rpm = requestHistory.length;
            const tpm = requestHistory.reduce((sum, r) => sum + r.k, 0);
            const rpd = s.count;

            setStatDisplay('rpm', rpm, LIMITS.RPM);
            setStatDisplay('tpm', tpm, LIMITS.TPM, true);
            setStatDisplay('rpd', rpd, LIMITS.RPD);
        }
        
        function setStatDisplay(id, val, limit, isToken = false) {
            const el = document.getElementById(`stat-${id}`);
            let valStr = val;
            let limitStr = limit;
            if(isToken) {
                valStr = (val >= 1000) ? (val/1000).toFixed(1) + "k" : val;
                limitStr = (limit >= 1000000) ? (limit/1000000) + "M" : limit;
            }
            el.innerText = `${valStr}/${limitStr}`;
            el.className = '';
            if (val >= limit) el.classList.add('limit-danger');
            else if (val >= limit * 0.8) el.classList.add('limit-warn');
        }
        setInterval(() => updateStats(0), 1000);

        window.saveProgress = () => {
             if (!window.currentSceneId) return;
             const now = new Date();
             const ts = now.toISOString().replace(/[:.]/g, '-').slice(0,19);
             const fname = `${window.cassetteFileName.replace('.json','')}_${ts}.json`;
             const data = {
                 cassetteFileName: window.cassetteFileName,
                 date: now.toLocaleString(),
                 currentSceneId: window.currentSceneId,
                 inventory: Array.from(window.inventory),
                 backUsed: window.backUsed,
                 lastTurnState: window.lastTurnState
             };
             const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
             const a = document.createElement('a');
             a.href = URL.createObjectURL(blob);
             a.download = fname;
             a.click();
        };

        window.executeBack = () => {
            if (!window.lastTurnState || window.backUsed) return;
            if(!confirm("1å›ã®ã¿æˆ»ã‚Œã¾ã™ã€‚å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ")) return;
            const prev = window.lastTurnState;
            window.inventory = prev.inventory;
            window.backUsed = true;
            updateInventoryUI();
            updateBackBtnState();
            addLog("--- æ™‚ã‚’æˆ»ã—ã¾ã—ãŸ ---", 'system');
            loadScene(prev.sceneId);
        };

        function updateBackBtnState() {
            const btn = document.getElementById('btn-back');
            if (window.lastTurnState && !window.backUsed) {
                btn.classList.remove('disabled');
            } else {
                btn.classList.add('disabled');
            }
        }

        window.updateInventoryUI = () => {
            const list = document.getElementById('inventory-list');
            list.innerHTML = window.inventory.size ? "" : "ãªã—";
            window.inventory.forEach(item => {
                const span = document.createElement('span');
                span.className = 'inventory-tag';
                span.innerText = item;
                list.appendChild(span);
            });
        };

        function addLog(text, type) {
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerHTML = text.replace(/\n/g, '<br>');
            const area = document.getElementById('chat-log-area');
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }
    </script>
</body>
</html>